@page
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Shop.Query.Categories._DTOs
@using Shop.UI.Services.Categories
@using Shop.UI.TagHelpers
@model Shop.UI.Pages.Admin.Products.AddModel
@inject ICategoryService CategoryService
@{
  ViewData["Title"] = "افزودن محصول";
  var id = Guid.NewGuid();
  var categories = await CategoryService.GetAll();

  const int textIndentationDefaultSize = 15;
  var textIndentation = textIndentationDefaultSize;
  var depth = 1;
  async Task AddSubCategories(CategoryDto parentCategory)
  {
    for (var i = 0; i < parentCategory.SubCategories.Count; i++)
    {
      var newId = Guid.NewGuid();
      var subCategory = parentCategory.SubCategories[i];
      var hasSubCategory = subCategory.SubCategories.Any();
      <tr class="children" style="display: none;" data-depth="@depth" data-categoryId="@subCategory.Id"
      data-parentCategoryId="@parentCategory.Id"
      data-hasSubCategory="@hasSubCategory.ToString().ToLower()">
        <td style="text-indent: @($"{textIndentation - 8}px");" class="pl-0 pr-0">
          @for (var t = 0; t < depth; t++)
          {
            <span class="indentation-lines"
            style="right: calc(0rem + @($"{t * textIndentationDefaultSize}px"))"></span>
          }
          <div class="d-inline-flex align-items-center">
            <label class="radio">
              <input type="radio" class="radio-primary" name="avatarId" id="@newId"
                 value="@subCategory.Id" />
              <label class="radio-circle" for="@newId"></label>
            </label>
            <span class="category-title" style="text-indent: 0; margin-right: 6px;">
              @subCategory.Title
              @if (hasSubCategory)
              {
                <i class="bx bx-caret-down"></i>
              }
            </span>
          </div>
        </td>
      </tr>
      if (hasSubCategory)
      {
        depth++;
        textIndentation += textIndentationDefaultSize;
        await AddSubCategories(subCategory);
        if (i + 1 == parentCategory.SubCategories.Count)
        {
          depth--;
          textIndentation = textIndentationDefaultSize * depth;
        }
      }
      else if (i + 1 == parentCategory.SubCategories.Count)
      {
        depth--;
        textIndentation = textIndentationDefaultSize * depth;
        return;
      }
    }
    depth++;
    textIndentation += textIndentationDefaultSize;
  }
}

<h5 class="mb-1">@ViewData["Title"]</h5>
<form method="post" class="card">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        @Html.EditorFor(m => m.CreateProductViewModel.MainImage)
      </div>
      <div class="col-md-4">
        <fieldset class="form-group">
          <label asp-for="@Model.CreateProductViewModel.GalleryImages"></label>
          <div class="custom-file">
            <input type="file" multiple="" class="custom-file-input" id="@id"
                   asp-for="@Model.CreateProductViewModel.GalleryImages">
            <span asp-validation-for="@Model.CreateProductViewModel.GalleryImages" class="d-block"></span>
            <label class="custom-file-label" for="@id">انتخاب فایل</label>
          </div>
        </fieldset>
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.CreateProductViewModel.Name)
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.CreateProductViewModel.EnglishName)
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.CreateProductViewModel.Slug)
      </div>
      <div class="col-md-12">
        <div class="form-group">
          <label asp-for="@Model.CreateProductViewModel.Description"></label>
          <textarea id="ckeditor4" class="form-control" asp-for="@Model.CreateProductViewModel.Description"></textarea>
          <span asp-validation-for="@Model.CreateProductViewModel.Description" class="d-block"></span>
        </div>
      </div>
      <div class="col-md-12">
        <div class="form-group">
          <label>دسته بندی</label>
          <fieldset class="position-relative has-icon-left category-search-box">
            <input type="text" class="form-control form-control-sm" id="category-search" placeholder="جستجو">
            <div class="form-control-position">
              <i class="bx bx-search"></i>
            </div>
          </fieldset>
          <table class="table mb-0 category-table">
            <tbody>
              @foreach (var category in categories)
              {
                var hasSubCategory = category.SubCategories.Any();
                <tr class="parent" data-depth="0" data-categoryId="@category.Id"
                  data-hasSubCategory="@hasSubCategory.ToString().ToLower()">
                  <td class="pl-0 pr-0">
                    <span class="category-title">
                      @category.Title
                      @if (hasSubCategory)
                      {
                        <i class="bx bx-caret-down"></i>
                      }
                    </span>
                  </td>
                </tr>
                @if (hasSubCategory)
                  await AddSubCategories(category);
              }
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-12" data-repeater-container="">
        <div class="form-group">
          <label>@Html.DisplayNameFor(m => m.CreateProductViewModel.Specifications)</label>
          <div data-repeater-list="">
            <div data-repeater-item="">
              <div class="row justify-content-between align-items-center">
                <div class="col-11">
                  @Html.EditorFor(m => m.CreateProductViewModel.Specifications)
                </div>
                <div class="col-1 d-flex justify-content-center">
                  <button class="btn btn-icon rounded-circle btn-danger" data-repeater-remove="" type="button">
                    <i class="bx bx-trash"></i>
                  </button>
                </div>
              </div>
              <hr>
            </div>
          </div>
          <div class="form-group m-0">
            <div class="col p-0">
              <button class="btn btn-primary" data-repeater-create="" type="button">
                <i class="bx bx-plus"></i>
                افزودن
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-12" data-repeater-container="">
        <div class="form-group">
          <label>@Html.DisplayNameFor(m => m.CreateProductViewModel.ExtraDescriptions)</label>
          <div data-repeater-list="">
            <div data-repeater-item="">
              <div class="row justify-content-between align-items-center">
                <div class="col-11">
                  @Html.EditorFor(m => m.CreateProductViewModel.ExtraDescriptions)
                </div>
                <div class="col-1 d-flex justify-content-center">
                  <button class="btn btn-icon rounded-circle btn-danger" data-repeater-remove="" type="button">
                    <i class="bx bx-trash"></i>
                  </button>
                </div>
              </div>
              <hr>
            </div>
          </div>
          <div class="form-group m-0 mb-3">
            <div class="col p-0">
              <button class="btn btn-primary" data-repeater-create="" type="button">
                <i class="bx bx-plus"></i>
                افزودن
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-success">
      <i class="bx bx-check d-block d-sm-none"></i>
      ایجاد
    </button>
    <cancel></cancel>
  </div>
</form>