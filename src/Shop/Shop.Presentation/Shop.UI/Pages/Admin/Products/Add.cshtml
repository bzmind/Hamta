@page
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Shop.Query.Categories._DTOs
@using Shop.UI.Services.Categories
@using Shop.UI.TagHelpers
@model Shop.UI.Pages.Admin.Products.AddModel
@inject ICategoryService CategoryService
@{
  ViewData["Title"] = "افزودن محصول";
  var id = Guid.NewGuid();
  var categories = await CategoryService.GetAll();

  const int textIndentationDefaultSize = 15;
  var textIndentation = textIndentationDefaultSize;
  var depth = 1;
  async Task AddSubCategories(CategoryDto parentCategory)
  {
    for (var i = 0; i < parentCategory.SubCategories.Count; i++)
    {
      var newId = Guid.NewGuid();
      var hasSubCategory = parentCategory.SubCategories[i].SubCategories.Any();
      <tr class="children" style="display: none;" data-depth="@depth"
      data-hasSubCategory="@hasSubCategory.ToString().ToLower()">
        <td style="text-indent: @($"{textIndentation - 8}px")">
          @for (var t = 0; t < depth; t++)
          {
            <span class="indentation-lines"
            style="right: calc(2rem + @($"{t * textIndentationDefaultSize}px"))"></span>
          }
          <label class="radio d-inline-block">
            <input type="radio" class="radio-primary" name="avatarId" id="@newId"
               value="@parentCategory.SubCategories[i].Id" />
            <label for="@newId">@parentCategory.SubCategories[i].Title</label>
          </label>
          @if (hasSubCategory)
          {
            <i class="bx bx-caret-down"></i>
          }
        </td>
      </tr>
      if (hasSubCategory)
      {
        depth++;
        textIndentation += textIndentationDefaultSize;
        await AddSubCategories(parentCategory.SubCategories[i]);
        if (i + 1 == parentCategory.SubCategories.Count)
        {
          depth--;
          textIndentation = textIndentationDefaultSize * depth;
        }
      }
      else if (i + 1 == parentCategory.SubCategories.Count)
      {
        depth--;
        textIndentation = textIndentationDefaultSize * depth;
        return;
      }
    }
    depth++;
    textIndentation += textIndentationDefaultSize;
  }
}

<h5 class="mb-1">@ViewData["Title"]</h5>
<form method="post" class="card">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        @Html.EditorFor(m => m.MainImage)
      </div>
      <div class="col-md-4">
        <fieldset class="form-group">
          <label asp-for="@Model.GalleryImages"></label>
          <div class="custom-file">
            <input type="file" multiple="" class="custom-file-input" id="@id" asp-for="@Model.GalleryImages">
            <span asp-validation-for="@Model.GalleryImages" class="d-block"></span>
            <label class="custom-file-label" for="@id">انتخاب فایل</label>
          </div>
        </fieldset>
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.Name)
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.EnglishName)
      </div>
      <div class="col-md-4">
        @Html.EditorFor(m => m.Slug)
      </div>
      <div class="col-md-12 mb-2">
        <div class="form-group">
          <label asp-for="@Model.Description"></label>
          <textarea id="ckeditor4" class="form-control" asp-for="@Model.Description"></textarea>
          <span asp-validation-for="@Model.Description" class="d-block"></span>
        </div>
      </div>
      <div class="col-md-12 mb-2">
        <div class="form-group">
          <label>دسته بندی</label>
          <fieldset class="position-relative has-icon-left">
            <input type="text" class="form-control form-control-sm" id="category-search" placeholder="جستجو">
            <div class="form-control-position">
              <i class="bx bx-search"></i>
            </div>
          </fieldset>
          <table class="table mb-0 category-table">
            <tbody>
              @foreach (var category in categories)
              {
                var hasSubCategory = category.SubCategories.Any();
                <tr class="parent" data-depth="0" data-hasSubCategory="@hasSubCategory.ToString().ToLower()">
                  <td>
                    @category.Title
                    @if (hasSubCategory)
                    {
                      <i class="bx bx-caret-down"></i>
                    }
                  </td>
                </tr>
                @if (hasSubCategory)
                  await AddSubCategories(category);
              }
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-12" data-repeater-container="">
        <div class="form-group">
          <label>@Html.DisplayNameFor(m => m.CustomSpecifications)</label>
          <div data-repeater-list="">
            <div data-repeater-item="">
              <div class="row justify-content-between align-items-center">
                <div class="col-11">
                  @Html.EditorFor(m => m.CustomSpecifications)
                </div>
                <div class="col-1 d-flex justify-content-center">
                  <button class="btn btn-icon rounded-circle btn-danger" data-repeater-remove="" type="button">
                    <i class="bx bx-trash"></i>
                  </button>
                </div>
              </div>
              <hr>
            </div>
          </div>
          <div class="form-group m-0 mb-3">
            <div class="col p-0">
              <button class="btn btn-primary" data-repeater-create="" type="button">
                <i class="bx bx-plus"></i>
                افزودن
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-success">
      <i class="bx bx-check d-block d-sm-none"></i>
      ایجاد
    </button>
    <cancel></cancel>
  </div>
</form>